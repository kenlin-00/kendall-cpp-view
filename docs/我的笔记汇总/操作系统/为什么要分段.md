

大家好，我是零K同学，点击左上角<font color="blue" size=4 font-weight=bolder>蓝字</font>关注公众号: <font color="blue" size=4 font-weight=bolder>零K同学</font>。

----

> 相信本公众号的友友们很多都学了汇编语言，可能都知道**分段机制**，那么，有没有想过，内存分段的由来，或者说内存为什么一定要分段呢？

> **我之前参加校招面试时，很多时候，面试官在问你某个原理题之前，都会先问你为什么需要这个东西，就比如说在问你分段机制之前，首先会问你为什么需要分段？**

## 为什么使用老的 CPU 学习

有没有发现，我们现在看的汇编语言相关的书籍或者视频，比如: 通俗易懂的汇编语言（王爽老师的书）: https://www.bilibili.com/video/BV1Wu411B72F?share_source=copy_web 。这门课，都是基于 8086 CPU 来讲解的。


> 为什么不拿新型号呢？用那么古老的 CPU 讲解知识，是不是已经落伍了呢？

其实不是，8086 CPU 是 Intel 历史上第一个 x86 的 CPU，也就是自从那以后的 CPU 称为 286、386、486、586...... 现在的新型号 CPU 也是属于 x86 体系的，其道理是不变的。而且，用最简单的 CPU 进行学习，这样才更容易理解和看透 CPU 运行机制。 

## 8086 是 CPU 界的重要里程碑

> 为什么这么说呢？

在 8086 之前的 CPU 没有【段】的概念，程序中要访问内存，需要把地址写死，也就是所谓的“硬编码”，这其实很麻烦的，首先程序无重定位，必须加载到内存中固定的位置，如果在这个位置有其他程序在用，那么该程序必须停下来等待，等其他程序运行结束了才能轮到自己。这种情况下，可用的内存很多，但是却因为某一个字节的内存被占用而让后来的程序等很久，这时候有些程序员等不及了，干脆把程序中的地址改成别的吧，重新编译后发现还是有某个地址被占用，还是没办法在 CPU 运行，怎么办，再改地址...... 所以我觉得那时候的程序员的脾气应该不会很好吧！

**人呐，脾气不好就容易伤肝**，肝火一旺就会头发发白，心疼呢。

### “段”来拯救

所以 Intel 早期的工程师熬了无数通宵之后，提出了“段”的概念，也就是我们现在所知道的：”段+偏移“的形式。这就是访问内存用“段基地址+段内偏移地址”的策略。它就是在 8086 上首次出现，从那以后 CPU 都是用这类思想访问内存，后面的改进也是在这思想的基础上进行改动。为了支持段机制，CPU 中新增了段寄存器，如 cs、ds、es等。


## 新的问题

8086 的地址总线是 20 位宽，也就是说它的寻址范围是 2<sup>20</sup>=1MB，但是它内部寄存器都是 16 位的，用单一寄存器来寻址的话，只能访问到 2<sup>16</sup>=64KB 的空间。那怎么办呢？

为了让 16 位的寄存器寻址能够访问 20位的地址空间，就要突破段寄存器的根本瓶颈，于是，可以先把 16 位的段基址左移 4 位后变成 20 位，再加段内偏移地址，这样便形成了 20 位地址啦。

> 解决了一个大问题，又有新的小问题

比如 0xFFFF, 现在能访问的最大地址是 0xFFFF：0xFFFF，经过左移段基址 4 位后得到的最大地址是：

```
0xFFFF*16+0xFFFF = 0xFFFF0+0xFFFF = 0xFFFFF+0xFFF0 = 1MB+16*4KB-16-1 = 0x10FFEF
```

公式虽然有点复杂，我们只需要关注最后的结果 0x10FFEF 就行了，通过上面公式可以看到最大地址是 1MB+64KB-16-1 ，好不容易才搞定了能够访问 20 位地址空间，到头来反而有点过了，过了的原因是段基址为 0xFFFF0，而偏移地址是 0xFFFF，超出了 0xFFF0 的空间，也就是多出来的 64KB-16 字节。

但是吧，这个小问题其实可以不用关注，你看，8086 一共就 20条地址，地址从 0 开始，也就是 A0~A19，所以其地址空间才是 1MB 啊，内存地址 0xFFFFF+ 超过了 20 位而产生的进位，就给丢掉了。比如：0xFFFFF+2 = 0x100001 ，但是只能容纳 20 位长的数据，所以最终结果是 0x00001，就是说超过最大范围后，从 0 重新开始计数那。这也就是**地址的回卷效果**。

![](https://cdn.jsdelivr.net/gh/kendall-cpp/blogPic@main/linux笔记01/地址回卷.4heo7l706y20.png)

> 参考《操作系统真象还原》


<font color="green" size=4>更多读书笔记关注公众号:**零K同学**</font>

![](https://cdn.jsdelivr.net/gh/kendall-cpp/blogPic@main/blog-img-02/公众号二维码.leozf4yvy34.jpg)
